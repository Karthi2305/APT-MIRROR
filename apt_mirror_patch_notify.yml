---
- name: Configure APT Mirror and Send Notification
  hosts: all
  become: true
  vars:
    mirror_url: "http://172.17.9.58/Ubuntu/mirror/archive.ubuntu.com/ubuntu"
    release: "noble"
    is_kali: "{{ ansible_distribution | lower == 'kali' }}"
    apt_sources_file: "/etc/apt/sources.list"
    sources_content_mint: |
      deb [arch=amd64 trusted=yes] {{ mirror_url }} {{ release }} main restricted universe multiverse
      deb [arch=amd64 trusted=yes] {{ mirror_url }} {{ release }}-updates main restricted universe multiverse
      deb [arch=amd64 trusted=yes] {{ mirror_url }} {{ release }}-security main restricted universe multiverse
    sources_content_kali: |
      deb [arch=amd64 signed-by=/etc/apt/keyrings/ubuntu.gpg] {{ mirror_url }} {{ release }} main restricted universe multiverse
      deb [arch=amd64 signed-by=/etc/apt/keyrings/ubuntu.gpg] {{ mirror_url }} {{ release }}-updates main restricted universe multiverse
      deb [arch=amd64 signed-by=/etc/apt/keyrings/ubuntu.gpg] {{ mirror_url }} {{ release }}-security main restricted universe multiverse

  tasks:

    - name: Update sources.list with local mirror
      copy:
        dest: "{{ apt_sources_file }}"
        content: "{{ sources_content_kali if is_kali else sources_content_mint }}"
        owner: root
        group: root
        mode: '0644'

    - name: Update APT package cache
      apt:
        update_cache: yes
      register: apt_result

    - name: Send notification email
  community.general.mail:
    host: smtp.gmail.com
    port: 587
    username: "aravind_slcs_intern2@aravind.org"
    password: "hjcqlojjlcatjwqq"  # App password (no spaces)
    to: "aravind_slcs_intern2@aravind.org"
    from: "aravind_slcs_intern2@aravind.org"
    subject: "ğŸ“¦ Mirror Patch Success on {{ inventory_hostname }}"
    body: |
      Hello Team,

      âœ… The system **{{ inventory_hostname }}** has been successfully patched using the local APT mirror.

      ğŸ–¥ï¸ Hostname         : {{ inventory_hostname }}
      ğŸ§  Operating System : {{ ansible_distribution }} {{ ansible_distribution_version }}
      ğŸŒ Mirror URL       : {{ mirror_url }}
      ğŸ“¦ Release          : {{ release }}
      ğŸ“… Timestamp        : {{ ansible_date_time.iso8601 }}

      ğŸ“Œ The following APT source list was configured:
      {{ (sources_content_kali if is_kali else sources_content_mint) | indent(2) }}

      ğŸ“ The system now fetches packages from the trusted internal repository.

      Regards,  
      ğŸ”§ Ansible Automation System
    secure: starttls
  delegate_to: localhost
  when: apt_result is succeeded
