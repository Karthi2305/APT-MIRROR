---
- name: Configure APT Mirror and Send Notification
  hosts: all
  become: yes
  vars:
    mirror_url: "http://172.17.9.58/Ubuntu/mirror/archive.ubuntu.com/ubuntu"
    release: "noble"
    is_kali: "{{ ansible_distribution == 'Kali' }}"
    sources_content_kali: |
      deb [arch=amd64 signed-by=/etc/apt/keyrings/ubuntu.gpg] {{ mirror_url }} {{ release }} main restricted universe multiverse
      deb [arch=amd64 signed-by=/etc/apt/keyrings/ubuntu.gpg] {{ mirror_url }} {{ release }}-updates main restricted universe multiverse
      deb [arch=amd64 signed-by=/etc/apt/keyrings/ubuntu.gpg] {{ mirror_url }} {{ release }}-security main restricted universe multiverse
    sources_content_mint: |
      deb [arch=amd64 trusted=yes] {{ mirror_url }} {{ release }} main restricted universe multiverse
      deb [arch=amd64 trusted=yes] {{ mirror_url }} {{ release }}-updates main restricted universe multiverse
      deb [arch=amd64 trusted=yes] {{ mirror_url }} {{ release }}-security main restricted universe multiverse

  tasks:
    - name: Update sources.list with local mirror
      copy:
        dest: /etc/apt/sources.list
        content: "{{ sources_content_kali if is_kali else sources_content_mint }}"
      register: sources_result

    - name: Update APT package cache
      apt:
        update_cache: yes
      register: apt_result

    - name: Send notification email
      community.general.mail:
        host: smtp.gmail.com
        port: 587
        username: "aravind_slcs_intern2@aravind.org"
        password: "{{ email_password }}"
        to: "aravind_slcs_intern2@aravind.org"
        from: "aravind_slcs_intern2@aravind.org"
        subject: "ğŸ“¦ Mirror Patch Report - {{ inventory_hostname }}"
        body: |
          Hello Team,

          The system **{{ inventory_hostname }}** has completed the mirror patch operation.

          ğŸ–¥ï¸ Hostname         : {{ inventory_hostname }}
          ğŸ§  OS               : {{ ansible_distribution }} {{ ansible_distribution_version }}
          ğŸŒ Mirror URL       : {{ mirror_url }}
          ğŸ“¦ Release          : {{ release }}
          ğŸ“… Timestamp        : {{ ansible_date_time.iso8601 }}

          ğŸ“ Source list file : {{ 'âœ… Updated' if sources_result.changed else 'âœ… Already Configured' }}
          ğŸ”„ APT Cache Status : {{ 'âœ… Refreshed' if apt_result.changed else 'ğŸ”„ No Updates Needed' }}

          ğŸ“Œ Source list content:
          {{ (sources_content_kali if is_kali else sources_content_mint) | indent(2) }}

          Regards,  
          ğŸ”§ Ansible Automation System
      delegate_to: localhost
